---
title: "Error example test"
output:
  rmarkdown::html_vignette:
  #BiocStyle::html_document:
    toc: true
vignette: >
  %\VignetteIndexEntry{Error example test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(gwhap)
```



# Test the haplotypes

Pour le même bloc, on prend trois différents haplotypes et on test leur différence.

```R
X_teou=fread("/neurospin/ukb/genetic/GENETIC_DATA_500k/HAPLOTYPES/blocks_19k_gz/all_sulci_boxcox.csv.hapDF_chr1_215146807_215154276.gz")
i=1
haplotypes_path = '/neurospin/tmp/ymekki/new_repo/gwhap/T1_subjects/haplotypes/haplotypes_'
load(sprintf('%schr%s.RData', haplotypes_path, i))


blocs = '215146807_215154276'
columns_blocs = str_subset(colnames(haplotype_combined), blocs)
haplotype_one_bloc = haplotype_combined[, columns_blocs]
```
==> results

```R
mean(X_teou$chr1_215146807_215154276_0000011 - haplotype_one_bloc$NA.chr1_215146807_215154276_0000011)
```

[1] 0

```R
mean(haplotype_one_bloc$NA.chr1_215146807_215154276_1000110 - X_teou$chr1_215146807_215154276_1000110)
```

[1] 0

```R
mean(haplotype_one_bloc$NA.chr1_215146807_215154276_0010010 - X_teou$chr1_215146807_215154276_0010010)
```

[1] 0




# residualisation

```R
cov_UKB = fread('/neurospin/ukb/workspace/pheno_boxcox/covar_SexAgeMRI_10PCSArray_19k.cov')
X_covar = c("IID", "Array", "Sex", "Age", "PC1", "PC2", "PC3", "PC4", "PC5", "PC6", "PC7", "PC8", "PC9", "PC10")

phenotypes_sulci = fread("/neurospin/ukb/workspace/pheno_boxcox/all_sulci_boxcox.tsv")
phenotype_filtred = phenotypes_sulci[, c('IID', 'FCMpost_left')]

Y_filtred_residualisee = phenotype_residualisation(phenotype=phenotype_filtred, covariates=cov_UKB[, ..X_covar], verbose=FALSE)

res = fread("/neurospin/ukb/workspace/pheno_boxcox/all_pheno_res.tsv")
res_f = dplyr::select(res, c('IID', 'FCMpost_left'))

results_merged = merge(res_f, Y_filtred_residualisee, by.x='IID', by.y='IID')
```

==> all_pheno_res.tsv n'est pas le résidu de all_sulci_boxcox.tsv ??????

# test




## même fonction pour le test mais les haplotypes une fois avec les tiens, une fois lautre


```R
X_teou=fread("/neurospin/ukb/genetic/GENETIC_DATA_500k/HAPLOTYPES/blocks_19k_gz/all_sulci_boxcox.csv.hapDF_chr1_215146807_215154276.gz")
lm_test_haplotypes(X_teou, dplyr::select(phenotypes_sulci, c('FCMpost_left')), kind='bloc')
```


|      start  |     end|   p_value| nb_subjects | nb_haplotypes|
|:------------|:-----|:------------|------------|:-----|
| 215146807| 215154276| 5.029542e-24 |      15612  |          23|


```R
bloc_test_path = Sys.glob(file.path("/neurospin/tmp/ymekki/new_repo/gwhap/T1_subjects/lm_test/chr_1/bloc_test_results/" , '*'))

bloc_test_df =  data.frame()
for(path in bloc_test_path){
  bloc_test_df <- rbind(bloc_test_df, data.frame(read_tsv(path)))
}
```
```R
bloc_test_df[bloc_test_df$start==215146807,]
```

|      start  |     end|   p_value| nb_subjects | nb_haplotypes|
|:------------|:-----|:------------|------------|:-----|
| 215146807 |  215154276  | 5.029542e-24  |     15612     |       23|

==> ok pour les haplotypes



## comparaison des résultats pour le test bloc pour le chromosome 1


Pour le chromosme 1, on test la différence des p value en moyenne sur l'ensemble du chromosme pour le test bloc et pour le phénotype FCMpost_left_block.

```R
sien = read_delim('/neurospin/tmp/ymekki/new_repo/gwhap/T1_subjects/FCMpost_left_block', delim=',')

start = vapply(strsplit(sien$rNames,"_"), `[`, 2, FUN.VALUE=character(1))
end = vapply(strsplit(sien$rNames,"_"), `[`, 3, FUN.VALUE=character(1))
chr_code = vapply(strsplit(sien$rNames,"_"), `[`, 1, FUN.VALUE=character(1))

sien$start = start
sien$end = end
sien$chr_code = chr_code
```


```R
bloc_test_path = Sys.glob(file.path("/neurospin/tmp/ymekki/new_repo/gwhap/T1_subjects/lm_test/chr_1/bloc_test_results/" , '*'))

bloc_test_df =  data.frame()
for(path in bloc_test_path){
  bloc_test_df <- rbind(bloc_test_df, data.frame(read_tsv(path)))
}
```

```R
results_merged = merge(bloc_test_df, sien, by.x='start', by.y='start')
diff = results_merged$p_value - results_merged$pv
mean(diff)
```

==> [1] 1.950054e-05




```R
results_merged[results_merged$start==215146807,]
```

|start|    end.x|      p_value| nb_subjects| nb_haplotypes |       pheno | test  |    rNames              | mafs     |   pv  | pvnum      |  end.y |chr_code |
|:----|:--------|:------------|------------|:--------------|:------------|:------|:-----------------------|----------|:------|:-----------|:-------|:--------|
|215146807|215154276| 5.029542e-24|      15612 |           23  | FCMpost_left| block |chr1_215146807_215154276| 15612 |4.96342e-24 |    4   |215154276|     chr1|




==> Ce n'est pas le même test qui est réalisé.









